#!/bin/bash
gcloud artifacts docker images list us-central1-docker.pkg.dev/instancify/gcf-artifacts --format="table[no-heading](DIGEST,CREATE_TIME,IMAGE)" | while read -r line; do digest=$(echo $line | cut -d" " -f1); create_time=$(echo $line | cut -d" " -f2); image=$(echo $line | cut -d" " -f3-); timestamp=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${create_time%.*}" "+%s"); current_time=$(date +%s); age_hours=$(( (current_time - timestamp) / 3600 )); if [ $age_hours -lt 24 ]; then continue; fi; latest_digest=$(gcloud artifacts docker images list us-central1-docker.pkg.dev/instancify/gcf-artifacts --filter="IMAGE=$image" --sort-by=~CREATE_TIME --limit=1 --format="value(DIGEST)"); if [ "$digest" != "$latest_digest" ]; then echo "Deleting old image: ${image}@sha256:${digest}"; gcloud artifacts docker images delete "${image}@sha256:${digest}" --quiet; fi; done
